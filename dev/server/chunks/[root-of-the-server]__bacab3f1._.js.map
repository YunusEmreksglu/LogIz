{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 118, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/asus/Desktop/LogIz/LogIz-LogIz/lib/supabase.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js'\r\n\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL || 'https://tmavagzxznmmwecbudux.supabase.co'\r\nconst supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY || process.env.SUPABASE_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRtYXZhZ3p4em5tbXdlY2J1ZHV4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3MDAwMzksImV4cCI6MjA3ODI3NjAzOX0.mkHQy0e3LN0hZfxEmnin5dpgycWJ6NHOp5fltrFUQF8'\r\n\r\nif (!supabaseKey) {\r\n    console.warn('⚠️ Supply a SUPABASE_KEY to use the Supabase client.')\r\n}\r\n\r\nexport const supabase = createClient(supabaseUrl, supabaseKey)\r\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,cAAc,gFAAwC;AAC5D,MAAM,cAAc,wPAA6C,QAAQ,GAAG,CAAC,YAAY,IAAI;AAE7F;;AAIO,MAAM,WAAW,IAAA,yLAAY,EAAC,aAAa","debugId":null}},
    {"offset": {"line": 133, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/asus/Desktop/LogIz/LogIz-LogIz/lib/auth.ts"],"sourcesContent":["import { NextAuthOptions } from \"next-auth\"\r\nimport CredentialsProvider from \"next-auth/providers/credentials\"\r\nimport { supabase } from \"@/lib/supabase\"\r\nimport bcrypt from \"bcryptjs\"\r\n\r\nexport const authOptions: NextAuthOptions = {\r\n  providers: [\r\n    CredentialsProvider({\r\n      name: \"credentials\",\r\n      credentials: {\r\n        email: { label: \"Email\", type: \"email\" },\r\n        password: { label: \"Password\", type: \"password\" }\r\n      },\r\n      async authorize(credentials) {\r\n        if (!credentials?.email || !credentials?.password) {\r\n          throw new Error(\"Email and password required\")\r\n        }\r\n\r\n        // Fetch user from Supabase 'users' table\r\n        const { data: user, error } = await supabase\r\n          .from('users')\r\n          .select('*')\r\n          .eq('email', credentials.email)\r\n          .single()\r\n\r\n        if (error || !user || !user.password) {\r\n          throw new Error(\"Invalid credentials\")\r\n        }\r\n\r\n        const isPasswordValid = await bcrypt.compare(\r\n          credentials.password,\r\n          user.password\r\n        )\r\n\r\n        if (!isPasswordValid) {\r\n          throw new Error(\"Invalid credentials\")\r\n        }\r\n\r\n        return {\r\n          id: user.id,\r\n          email: user.email,\r\n          name: user.name,\r\n          role: user.role,\r\n        }\r\n      }\r\n    })\r\n  ],\r\n  session: {\r\n    strategy: \"jwt\"\r\n  },\r\n  pages: {\r\n    signIn: \"/login\",\r\n  },\r\n  callbacks: {\r\n    async jwt({ token, user }) {\r\n      if (user) {\r\n        token.id = user.id\r\n        token.role = user.role\r\n      }\r\n      return token\r\n    },\r\n    async session({ session, token }) {\r\n      if (session.user) {\r\n        session.user.id = token.id as string\r\n        session.user.role = token.role as string\r\n      }\r\n      return session\r\n    }\r\n  },\r\n  secret: process.env.NEXTAUTH_SECRET || \"development_secret_key_123\",\r\n}\r\n"],"names":[],"mappings":";;;;AACA;AACA;AACA;;;;AAEO,MAAM,cAA+B;IAC1C,WAAW;QACT,IAAA,qKAAmB,EAAC;YAClB,MAAM;YACN,aAAa;gBACX,OAAO;oBAAE,OAAO;oBAAS,MAAM;gBAAQ;gBACvC,UAAU;oBAAE,OAAO;oBAAY,MAAM;gBAAW;YAClD;YACA,MAAM,WAAU,WAAW;gBACzB,IAAI,CAAC,aAAa,SAAS,CAAC,aAAa,UAAU;oBACjD,MAAM,IAAI,MAAM;gBAClB;gBAEA,yCAAyC;gBACzC,MAAM,EAAE,MAAM,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,6HAAQ,CACzC,IAAI,CAAC,SACL,MAAM,CAAC,KACP,EAAE,CAAC,SAAS,YAAY,KAAK,EAC7B,MAAM;gBAET,IAAI,SAAS,CAAC,QAAQ,CAAC,KAAK,QAAQ,EAAE;oBACpC,MAAM,IAAI,MAAM;gBAClB;gBAEA,MAAM,kBAAkB,MAAM,8IAAM,CAAC,OAAO,CAC1C,YAAY,QAAQ,EACpB,KAAK,QAAQ;gBAGf,IAAI,CAAC,iBAAiB;oBACpB,MAAM,IAAI,MAAM;gBAClB;gBAEA,OAAO;oBACL,IAAI,KAAK,EAAE;oBACX,OAAO,KAAK,KAAK;oBACjB,MAAM,KAAK,IAAI;oBACf,MAAM,KAAK,IAAI;gBACjB;YACF;QACF;KACD;IACD,SAAS;QACP,UAAU;IACZ;IACA,OAAO;QACL,QAAQ;IACV;IACA,WAAW;QACT,MAAM,KAAI,EAAE,KAAK,EAAE,IAAI,EAAE;YACvB,IAAI,MAAM;gBACR,MAAM,EAAE,GAAG,KAAK,EAAE;gBAClB,MAAM,IAAI,GAAG,KAAK,IAAI;YACxB;YACA,OAAO;QACT;QACA,MAAM,SAAQ,EAAE,OAAO,EAAE,KAAK,EAAE;YAC9B,IAAI,QAAQ,IAAI,EAAE;gBAChB,QAAQ,IAAI,CAAC,EAAE,GAAG,MAAM,EAAE;gBAC1B,QAAQ,IAAI,CAAC,IAAI,GAAG,MAAM,IAAI;YAChC;YACA,OAAO;QACT;IACF;IACA,QAAQ,QAAQ,GAAG,CAAC,eAAe,IAAI;AACzC","debugId":null}},
    {"offset": {"line": 207, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/asus/Desktop/LogIz/LogIz-LogIz/app/api/upload/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\r\nimport { writeFile } from 'fs/promises'\r\nimport { join } from 'path'\r\nimport { getServerSession } from 'next-auth'\r\nimport { authOptions } from '@/lib/auth'\r\nimport { supabase } from '@/lib/supabase'\r\nimport { randomUUID } from 'crypto'\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const formData = await request.formData()\r\n    const file = formData.get('file') as File\r\n\r\n    if (!file) {\r\n      return NextResponse.json(\r\n        { error: 'No file provided' },\r\n        { status: 400 }\r\n      )\r\n    }\r\n\r\n    // Validate file size (default 50MB)\r\n    const maxSize = parseInt(process.env.MAX_FILE_SIZE || '52428800')\r\n    if (file.size > maxSize) {\r\n      return NextResponse.json(\r\n        { error: 'File size exceeds limit' },\r\n        { status: 400 }\r\n      )\r\n    }\r\n\r\n    // Validate file type\r\n    const allowedTypes = ['.log', '.txt', '.csv', '.json']\r\n    const fileExt = file.name.substring(file.name.lastIndexOf('.')).toLowerCase()\r\n    if (!allowedTypes.includes(fileExt)) {\r\n      return NextResponse.json(\r\n        { error: `Invalid file type. Allowed: ${allowedTypes.join(', ')}` },\r\n        { status: 400 }\r\n      )\r\n    }\r\n\r\n    // Generate unique filename\r\n    const timestamp = Date.now()\r\n    const filename = `${timestamp}-${file.name.replace(/[^a-zA-Z0-9.-]/g, '_')}`\r\n\r\n    // Save file to disk\r\n    const bytes = await file.arrayBuffer()\r\n    const buffer = Buffer.from(bytes)\r\n    const uploadDir = process.env.UPLOAD_DIR\r\n      ? join(process.cwd(), process.env.UPLOAD_DIR)\r\n      : join(process.cwd(), 'public', 'uploads')\r\n\r\n    const filePath = join(uploadDir, filename)\r\n\r\n    await writeFile(filePath, buffer)\r\n\r\n    // Get userId from session (if logged in)\r\n    // Use Service Role client to bypass RLS for server-side processing\r\n    const { createClient } = await import('@supabase/supabase-js')\r\n    const supabaseAdmin = createClient(\r\n      process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n      process.env.SUPABASE_SERVICE_ROLE_KEY!,\r\n      {\r\n        auth: {\r\n          autoRefreshToken: false,\r\n          persistSession: false\r\n        }\r\n      }\r\n    )\r\n\r\n    // Get userId from session (if logged in)\r\n    const session = await getServerSession(authOptions)\r\n    let userId = session?.user?.id || null\r\n\r\n    // Check if user actually exists in DB (to handle stale sessions)\r\n    if (userId) {\r\n      const { data: userExists } = await supabaseAdmin\r\n        .from('users')\r\n        .select('id')\r\n        .eq('id', userId)\r\n        .single()\r\n\r\n      if (!userExists) {\r\n        console.warn(`Stale session detected: User ID ${userId} not found in DB. Treating as anonymous upload.`)\r\n        userId = null\r\n      }\r\n    }\r\n\r\n    // If no valid user, use anonymous placeholder or skip user_id\r\n    // Note: log_files.user_id should be nullable in schema for anonymous uploads\r\n    // Build insert object conditionally\r\n    const insertData: any = {\r\n      id: randomUUID(),\r\n      filename,\r\n      original_name: file.name,\r\n      file_path: `/uploads/${filename}`,\r\n      file_size: file.size,\r\n      file_type: fileExt,\r\n      status: 'PENDING',\r\n    }\r\n\r\n    // Only include user_id if it's not null\r\n    if (userId) {\r\n      insertData.user_id = userId\r\n    }\r\n\r\n    const { data: logFile, error } = await supabaseAdmin\r\n      .from('log_files')\r\n      .insert(insertData)\r\n      .select()\r\n      .single()\r\n\r\n    if (error) {\r\n      console.error('Supabase insert error (First attempt):', error)\r\n\r\n      // Fallback: If error is related to user_id (foreign key), try anonymous upload\r\n      if (insertData.user_id) {\r\n        console.warn('Retrying upload as anonymous user...')\r\n        delete insertData.user_id\r\n        const { data: retryData, error: retryError } = await supabaseAdmin\r\n          .from('log_files')\r\n          .insert(insertData)\r\n          .select()\r\n          .single()\r\n\r\n        if (retryError) {\r\n          console.error('Supabase insert error (Retry):', retryError)\r\n          // Log to file for debugging\r\n          try {\r\n            const { appendFile } = await import('fs/promises')\r\n            await appendFile('upload_errors.log', `${new Date().toISOString()} - Upload Error: ${JSON.stringify(retryError)}\\n`)\r\n          } catch (e) { }\r\n          throw retryError\r\n        }\r\n\r\n        // Retry successful\r\n        return NextResponse.json({\r\n          success: true,\r\n          logFile: {\r\n            id: retryData.id,\r\n            filename: retryData.original_name,\r\n            size: retryData.file_size,\r\n          },\r\n        })\r\n      }\r\n\r\n      throw error\r\n    }\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      logFile: {\r\n        id: logFile.id,\r\n        filename: logFile.original_name,\r\n        size: logFile.file_size,\r\n      },\r\n    })\r\n  } catch (error) {\r\n    console.error('Upload error:', error)\r\n    return NextResponse.json(\r\n      { error: 'Failed to upload file' },\r\n      { status: 500 }\r\n    )\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}