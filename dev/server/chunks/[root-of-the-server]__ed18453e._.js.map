{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/asus/Desktop/LogIz/LogIz-LogIz/app/api/analyze/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\";\r\nimport { readFile } from \"fs/promises\";\r\nimport { join } from \"path\";\r\nimport { randomUUID } from \"crypto\";\r\nimport { supabase } from \"@/lib/supabase\";\r\nimport { analyzeLog } from \"@/lib/analysis-engine\";\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    const { logFileId } = await request.json();\r\n\r\n    if (!logFileId) {\r\n      return NextResponse.json({ error: \"Log file ID is required\" }, { status: 400 });\r\n    }\r\n\r\n    // Use Service Role client to bypass RLS for analysis processing\r\n    const { createClient } = await import('@supabase/supabase-js')\r\n    const supabaseAdmin = createClient(\r\n      process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n      process.env.SUPABASE_SERVICE_ROLE_KEY!,\r\n      {\r\n        auth: {\r\n          autoRefreshToken: false,\r\n          persistSession: false\r\n        }\r\n      }\r\n    )\r\n\r\n    const { data: logFile, error: fileError } = await supabaseAdmin\r\n      .from('log_files')\r\n      .select('*')\r\n      .eq('id', logFileId)\r\n      .single();\r\n\r\n    if (fileError || !logFile) {\r\n      return NextResponse.json({ error: \"Log file not found\" }, { status: 404 });\r\n    }\r\n\r\n    await supabaseAdmin\r\n      .from('log_files')\r\n      .update({ status: \"PROCESSING\" })\r\n      .eq('id', logFileId);\r\n\r\n    const filePath = join(process.cwd(), \"public\", logFile.file_path);\r\n\r\n    const startTime = Date.now();\r\n    let analysisResult;\r\n\r\n    try {\r\n      console.log(\"Running Python Analysis directly...\");\r\n\r\n      const { exec } = await import('child_process');\r\n      const { promisify } = await import('util');\r\n      const execAsync = promisify(exec);\r\n\r\n      const pythonScriptPath = join(process.cwd(), \"backend\", \"analyze_direct.py\");\r\n\r\n      // Use python command - on Windows this is usually 'python'\r\n      const { stdout, stderr } = await execAsync(`python \"${pythonScriptPath}\" \"${filePath}\"`);\r\n\r\n      if (stderr && !stdout) {\r\n        throw new Error(`Python Error: ${stderr}`);\r\n      }\r\n\r\n      const pythonData = JSON.parse(stdout);\r\n\r\n      if (!pythonData.success) {\r\n        throw new Error(pythonData.error || \"Analysis failed\");\r\n      }\r\n\r\n      console.log(\"Python Analysis Complete\");\r\n\r\n      // Map Python response to internal format\r\n      analysisResult = {\r\n        success: pythonData.success,\r\n        threatCount: pythonData.results.attacks_detected,\r\n        threats: pythonData.attacks,\r\n        summary: {\r\n          critical: pythonData.severity_summary?.CRITICAL || 0,\r\n          high: pythonData.severity_summary?.HIGH || 0,\r\n          medium: pythonData.severity_summary?.MEDIUM || 0,\r\n          low: pythonData.severity_summary?.LOW || 0,\r\n          info: pythonData.severity_summary?.INFO || 0\r\n        },\r\n        processingTime: (pythonData.results.prediction_time_seconds || 0) * 1000,\r\n        totalLogLines: pythonData.results.total_records,\r\n        attack_type_distribution: pythonData.attack_type_distribution\r\n      };\r\n\r\n    } catch (error: any) {\r\n      console.error(\"Engine execution failed:\", error);\r\n      analysisResult = {\r\n        success: false,\r\n        threatCount: 0,\r\n        threats: [],\r\n        summary: { critical: 0, high: 0, medium: 0, low: 0, info: 0 },\r\n        processingTime: 0,\r\n        error: error.message || \"Analysis failed\"\r\n      };\r\n    }\r\n\r\n    const processingTime = Date.now() - startTime;\r\n\r\n    const analysisId = randomUUID();\r\n\r\n    const { data: analysis, error: analysisError } = await supabaseAdmin\r\n      .from('analyses')\r\n      .insert({\r\n        id: analysisId,\r\n        log_file_id: logFileId,\r\n        user_id: logFile.user_id, // Link analysis to user directly\r\n        result: analysisResult,\r\n        threat_count: analysisResult.threatCount,\r\n        high_severity: analysisResult.summary.critical + analysisResult.summary.high,\r\n        medium_severity: analysisResult.summary.medium,\r\n        low_severity: analysisResult.summary.low,\r\n        status: \"COMPLETED\",\r\n        processing_time: processingTime,\r\n      })\r\n      .select('id, threat_count, processing_time')\r\n      .single();\r\n\r\n    if (analysisError || !analysis) {\r\n      throw analysisError || new Error(\"Failed to save analysis\");\r\n    }\r\n\r\n    const threatInserts = await Promise.all(\r\n      analysisResult.threats.map(async (threat: any) => {\r\n        // Geolocate IP\r\n        let geoInfo = null\r\n        try {\r\n          if (threat.sourceIP && threat.sourceIP !== 'N/A') {\r\n            const geo = require('geoip-lite')\r\n            // Attempt to look up the IP\r\n            geoInfo = geo.lookup(threat.sourceIP)\r\n          }\r\n        } catch (geoError) {\r\n          // If geoip fails (e.g. file not found), just ignore it and continue cleanly\r\n          // console.warn(\"GeoIP lookup failed:\", geoError);\r\n        }\r\n\r\n        return {\r\n          id: randomUUID(),\r\n          analysis_id: analysis.id,\r\n          type: threat.type,\r\n          severity: threat.severity,\r\n          description: threat.description,\r\n          source_ip: threat.sourceIP,\r\n          target_ip: threat.targetIP,\r\n          port: threat.port,\r\n          timestamp: threat.timestamp ? new Date(threat.timestamp).toISOString() : null,\r\n          raw_log: threat.rawLog,\r\n          confidence: threat.confidence,\r\n          // Geolocation data\r\n          source_lat: geoInfo?.ll?.[0] || null,\r\n          source_lon: geoInfo?.ll?.[1] || null,\r\n          source_country: geoInfo?.country || null,\r\n        }\r\n      })\r\n    );\r\n\r\n    const { data: threats, error: threatError } = await supabaseAdmin\r\n      .from('threats')\r\n      .insert(threatInserts)\r\n      .select('*');\r\n\r\n    if (threatError) {\r\n      console.error(\"Threat insert error:\", threatError);\r\n      // Continue even if logging threats fails, but log it.\r\n    }\r\n\r\n    await supabaseAdmin\r\n      .from('log_files')\r\n      .update({ status: \"COMPLETED\" })\r\n      .eq('id', logFileId);\r\n\r\n    // Send notifications for critical threats\r\n    try {\r\n      const criticalThreats = analysisResult.threats.filter((t: any) => t.severity === 'CRITICAL')\r\n      if (criticalThreats.length > 0) {\r\n        const { sendNotifications } = await import('@/lib/notifications')\r\n\r\n        // Get user email if available\r\n        let userEmail = null;\r\n        if (logFile.user_id) {\r\n          const { data: userData } = await supabaseAdmin\r\n            .from('users')\r\n            .select('email')\r\n            .eq('id', logFile.user_id)\r\n            .single();\r\n          userEmail = userData?.email;\r\n        }\r\n\r\n        await sendNotifications(analysis.id, analysisResult.threats, {\r\n          email: userEmail ? { to: userEmail } : undefined,\r\n          slack: process.env.SLACK_WEBHOOK_URL ? { webhookUrl: process.env.SLACK_WEBHOOK_URL } : undefined\r\n        })\r\n      }\r\n    } catch (notifError) {\r\n      console.error('Notification error:', notifError)\r\n      // Don't fail the request if notifications fail\r\n    }\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      analysis: {\r\n        id: analysis.id,\r\n        threatCount: analysis.threat_count,\r\n        processingTime: analysis.processing_time,\r\n        severity_summary: {\r\n          CRITICAL: analysisResult.summary.critical,\r\n          HIGH: analysisResult.summary.high,\r\n          MEDIUM: analysisResult.summary.medium,\r\n          LOW: analysisResult.summary.low,\r\n          INFO: analysisResult.summary.info\r\n        },\r\n        attack_type_distribution: analysisResult.attack_type_distribution || {},\r\n        threats: threats?.map((t: any) => ({\r\n          ...t,\r\n          sourceIP: t.source_ip,\r\n          targetIP: t.target_ip,\r\n          rawLog: t.raw_log,\r\n          sourceLat: t.source_lat,\r\n          sourceLon: t.source_lon,\r\n          sourceCountry: t.source_country,\r\n          analysisId: t.analysis_id\r\n        })),\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error(\"Analysis error:\", error);\r\n    return NextResponse.json({ error: \"Failed to analyze log file\" }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}