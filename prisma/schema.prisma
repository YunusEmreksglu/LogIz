// Prisma Schema for LogIz - Cybersecurity Log Analysis Platform

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String    @unique
  emailVerified DateTime?
  password      String
  image         String?
  role          UserRole  @default(USER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  logFiles      LogFile[]
  apiKeys       ApiKey[]
  
  @@map("users")
}

enum UserRole {
  USER
  ADMIN
  ANALYST
}

model LogFile {
  id            String      @id @default(cuid())
  filename      String
  originalName  String
  filePath      String
  fileSize      Int
  fileType      String
  status        FileStatus  @default(PENDING)
  uploadedAt    DateTime    @default(now())
  
  userId        String?
  user          User?       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  analyses      Analysis[]
  
  @@map("log_files")
  @@index([userId])
  @@index([status])
}

enum FileStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

model Analysis {
  id              String          @id @default(cuid())
  result          Json            // Python API response
  threatCount     Int             @default(0)
  highSeverity    Int             @default(0)
  mediumSeverity  Int             @default(0)
  lowSeverity     Int             @default(0)
  status          AnalysisStatus  @default(PENDING)
  analyzedAt      DateTime        @default(now())
  processingTime  Int?            // milliseconds
  
  logFileId       String
  logFile         LogFile         @relation(fields: [logFileId], references: [id], onDelete: Cascade)
  
  threats         Threat[]
  
  @@map("analyses")
  @@index([logFileId])
  @@index([status])
}

enum AnalysisStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
}

model Threat {
  id          String        @id @default(cuid())
  type        String        // SQL_INJECTION, XSS, BRUTE_FORCE, etc.
  severity    ThreatLevel
  description String
  sourceIP    String?
  targetIP    String?
  port        Int?
  timestamp   DateTime?
  rawLog      String?
  confidence  Float?        // 0-1 score from AI model
  
  // Geolocation
  sourceLat   Float?
  sourceLon   Float?
  sourceCountry String?
  
  analysisId  String
  analysis    Analysis      @relation(fields: [analysisId], references: [id], onDelete: Cascade)
  
  @@map("threats")
  @@index([analysisId])
  @@index([severity])
  @@index([type])
}

enum ThreatLevel {
  CRITICAL
  HIGH
  MEDIUM
  LOW
  INFO
}

model ApiKey {
  id          String    @id @default(cuid())
  name        String
  key         String    @unique
  lastUsed    DateTime?
  createdAt   DateTime  @default(now())
  expiresAt   DateTime?
  isActive    Boolean   @default(true)
  
  userId      String
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("api_keys")
  @@index([userId])
}

// Live Monitoring Sessions
model LiveSession {
  id            String    @id @default(cuid())
  host          String
  port          Int       @default(22)
  username      String
  logPath       String
  startedAt     DateTime  @default(now())
  endedAt       DateTime?
  
  // Stats
  totalLogs     Int       @default(0)
  criticalCount Int       @default(0)
  highCount     Int       @default(0)
  mediumCount   Int       @default(0)
  lowCount      Int       @default(0)
  infoCount     Int       @default(0)
  
  // Threat type distribution (JSON)
  threatTypes   Json?     // e.g., {"BRUTE_FORCE": 5, "ROOT_LOGIN": 1}
  
  logs          LiveLog[]
  
  @@map("live_sessions")
  @@index([startedAt])
}

model LiveLog {
  id          String      @id @default(cuid())
  timestamp   DateTime    @default(now())
  raw         String
  threatType  String?     // BRUTE_FORCE, ROOT_LOGIN, etc.
  severity    ThreatLevel
  description String
  sourceIP    String?
  username    String?
  
  sessionId   String
  session     LiveSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@map("live_logs")
  @@index([sessionId])
  @@index([severity])
  @@index([threatType])
}

